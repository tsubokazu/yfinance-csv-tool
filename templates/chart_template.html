
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #ffffff;
        }
        .chart-container {
            width: 1000px;
            height: 600px;
            margin: 0 auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
        }
        .chart-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .chart-info {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="chart-title">{{ symbol }} - {{ timeframe_name }}</div>
    <div class="chart-info">{{ time_range }}</div>
    <div id="chart" class="chart-container"></div>
    
    <script>
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            width: 1000,
            height: 600,
            layout: {
                backgroundColor: '#ffffff',
                textColor: '#333',
            },
            grid: {
                vertLines: {
                    color: '#f0f0f0',
                },
                horzLines: {
                    color: '#f0f0f0',
                },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#cccccc',
            },
            timeScale: {
                borderColor: '#cccccc',
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // ローソク足データの追加
        const candlestickSeries = chart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderVisible: false,
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350',
        });
        
        const candleData = {{ candle_data|safe }};
        candlestickSeries.setData(candleData);

        // 出来高データの追加
        const volumeSeries = chart.addHistogramSeries({
            color: '#26a69a',
            priceFormat: {
                type: 'volume',
            },
            priceScaleId: 'volume',
            scaleMargins: {
                top: 0.8,
                bottom: 0,
            },
        });
        
        const volumeData = {{ volume_data|safe }};
        volumeSeries.setData(volumeData);

        // 移動平均線の追加
        {% for ma_period, ma_data in moving_averages.items() %}
        const ma{{ ma_period }}Series = chart.addLineSeries({
            color: '{{ ma_colors[ma_period] }}',
            lineWidth: 2,
            title: 'MA{{ ma_period }}',
        });
        ma{{ ma_period }}Series.setData({{ ma_data|safe }});
        {% endfor %}

        // VWAP（該当時間軸のみ）
        {% if vwap_data %}
        const vwapSeries = chart.addLineSeries({
            color: '#FF6B35',
            lineWidth: 2,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            title: 'VWAP',
        });
        vwapSeries.setData({{ vwap_data|safe }});
        {% endif %}

        // ボリンジャーバンド（60分足のみ）
        {% if bollinger_bands %}
        const bbUpperSeries = chart.addLineSeries({
            color: '#9C27B0',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            title: 'BB Upper',
        });
        bbUpperSeries.setData({{ bollinger_bands.upper|safe }});
        
        const bbLowerSeries = chart.addLineSeries({
            color: '#9C27B0',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            title: 'BB Lower',
        });
        bbLowerSeries.setData({{ bollinger_bands.lower|safe }});
        {% endif %}

        // チャートのフィット
        chart.timeScale().fitContent();
        
        // レンダリング完了のマーク
        window.chartReady = true;
    </script>
</body>
</html>
        