# 立花証券e支店 API仕様書

## 概要

立花証券e支店のJSON APIは、プログラムから株式取引システムにアクセスするためのWebベースAPIです。

### 基本情報
- **プロトコル**: HTTPS
- **データ形式**: JSON
- **文字エンコーディング**: Shift-JIS
- **APIバージョン**: v4r3（動作確認済み）
- **動作環境**: CentOS 7.4, Python 3.6.8で検証済み

### 重要な注意事項
⚠️ **本番環境に接続した場合、実際に注文を出すことができます**
- テスト時は必ずデモ環境を使用すること
- 実際の取引が発生する可能性があるため十分注意すること

## 認証システム

### 前提条件
- 立花証券e支店の口座が必要
- ユーザーID、パスワードが必要

### ログインプロセス

1. **認証リクエスト**
   ```
   Method: GET
   Content-Type: application/json
   Encoding: Shift-JIS
   ```

2. **必要なパラメータ**
   - `my_userid`: ユーザーID
   - `my_passwd`: パスワード

3. **レスポンス**
   - ログイン成功時に仮想URLが生成される
   - 以下の4つのインターフェースURL:
     - Request Interface
     - Master Interface  
     - Price Interface
     - Event Interface

4. **セッション管理**
   - ログイン後、生成された仮想URLを使用してAPI呼び出し
   - 1リクエスト：1レスポンスの通信モデル
   - 使用後は必ずログアウトが必要

### ログアウトプロセス
- セッション終了時に必須
- リソースの適切な解放のため

## APIインターフェース

### 1. REQUEST I/F（リクエストインターフェース）
- **用途**: 各種データ取得、注文処理
- **プロトコル**: HTTPS GET
- **制限**: 1回のリクエストで最大120レコード取得可能

### 2. MASTER I/F（マスターインターフェース）
- **用途**: マスターデータの取得
- **取得可能データ**: 銘柄情報、市場情報等

### 3. PRICE I/F（価格インターフェース）
- **用途**: 株価データの取得
- **取得可能データ**: 
  - リアルタイム株価
  - 履歴株価データ（日足）
  - スナップショット価格

### 4. EVENT I/F（イベントインターフェース）
- **用途**: リアルタイム通知の受信
- **プロトコル**: 
  - HTTP（Chunk Response）
  - WebSocket

## データ取得API

### 株価データ取得

#### リアルタイム株価
```python
# サンプルファイル: e_api_get_price_from_file.py
```
- **機能**: ファイルにリストされた銘柄の株価をスナップショットで取得
- **入力**: price_list_in.csv
- **出力**: 株価データファイル

#### 履歴株価データ（日足）
```python
# サンプルファイル: e_api_get_histrical_price_daily.py
```
- **機能**: 指定銘柄の日足株価データを取得
- **データ項目**: 始値、高値、安値、終値、出来高等

### ニュースデータ取得
```python
# サンプルファイル: e_api_get_news_header.py
```
- **機能**: ニュースヘッダー情報の取得

### マスターデータ取得
```python
# サンプルファイル: e_api_get_master.py
```
- **機能**: マスターデータのダウンロード

## 注文・取引API

### 注文詳細取得
```python
# サンプルファイル: e_api_get_orderlist_detail.py
```
- **機能**: 注文約定詳細の取得
- **取得データ**: 注文状況、約定情報

### 注文処理
- **新規注文**: 成行・指値注文の発注
- **注文変更**: 既存注文の変更
- **注文取消**: 既存注文の取消

## エラーハンドリング

### エラーコード
- **p_errno**: エラーコードが返される
- 各API呼び出し時にエラーコードの確認が必要

### エラー対応
1. エラーコードの確認
2. エラー詳細の取得
3. 適切な例外処理の実装

## 制限事項

### 利用制限
- 事前認証が必須
- 特定の利用シナリオに限定
- 営業時間外はサービス利用不可の場合あり

### 技術的制限
- 1リクエストあたり最大120レコード
- 文字エンコーディングはShift-JIS
- 日本語文字列の処理に注意が必要

## 実装時の注意点

### 文字エンコーディング
- Shift-JIS エンコーディングを使用
- 日本語文字列の適切な処理が必要

### セッション管理
- ログイン後の仮想URL管理
- 適切なログアウト処理
- エラー時のセッションクリーンアップ

### 安全性
- 認証情報の安全な管理
- 本番環境での誤操作防止
- 十分なテストの実施

## サンプルコード

### 基本的な使用フロー
```python
import urllib3

# 1. ログイン
# 2. 仮想URL取得
# 3. APIデータ取得/注文処理
# 4. ログアウト
```

### 利用可能なサンプル
- `e_api_loginout.py`: ログイン・ログアウト
- `e_api_get_price_from_file.py`: 株価取得
- `e_api_get_histrical_price_daily.py`: 履歴株価取得
- `e_api_get_news_header.py`: ニュース取得
- `e_api_get_master.py`: マスターデータ取得
- `e_api_get_orderlist_detail.py`: 注文詳細取得

## 参考リンク

- [公式API仕様](https://www.e-shiten.jp/e_api/mfds_json_api_menu.html)
- [GitHubサンプルコード](https://github.com/e-shiten-jp)
- [立花証券e支店](https://www.e-shiten.jp/)

## ライセンス・免責事項

- サンプルコードはMITライセンス
- 利用者の自己責任での使用
- 実際の取引による損害は利用者負担

## 実装状況 (Phase 1完了)

### ✅ **完了済み機能**
- **認証システム** - デモ・本番環境で完全動作
- **セッション管理** - 仮想URL管理、タイムアウト処理
- **文字エンコーディング** - Shift-JIS完全対応
- **JSON-in-GET方式** - 公式仕様準拠
- **安全機能** - DEMO_MODE、本番環境保護

### 🔄 **Phase 2で実装予定**
- **後続API完全実装** - 株価取得、マスターデータ、注文処理
- **LLM連携機能** - チャート分析、自動売買判断
- **監視・ログ機能** - 取引履歴、リスク管理

### 📊 **検証済み環境**
- **デモ環境**: `https://demo-kabuka.e-shiten.jp/e_api_v4r7/`
- **本番環境**: `https://kabuka.e-shiten.jp/e_api_v4r7/`
- **仮想URL**: `https://price-kabuka.e-shiten.jp/e_api_v4r7/[interface]/[sessionId]/`

---

**最終更新**: 2025年7月25日  
**検証バージョン**: v4r7 (最新)  
**Phase 1**: ✅ 完了